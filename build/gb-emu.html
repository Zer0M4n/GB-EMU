<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GameBoy Emulator - WebAssembly</title>
    <style>
        body {
            background-color: #202020;
            color: white;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .gb-case {
            background-color: #c0c0c0;
            padding: 20px;
            border-radius: 10px 10px 40px 10px;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .screen-border {
            background-color: #505050;
            padding: 20px 40px;
            border-radius: 10px 10px 30px 10px;
            margin-bottom: 20px;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5);
        }
        canvas {
            background-color: #9bbc0f; /* Color cl√°sico GB apagado */
            width: 320px;
            height: 288px;
            image-rendering: pixelated;
            border: 2px solid #333;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        }
        
        /* --- ESTILOS DEL CARGADOR DE ROM (NUEVO) --- */
        .cartridge-slot {
            margin-bottom: 15px;
            width: 100%;
            text-align: center;
        }
        input[type="file"] {
            display: none;
        }
        .file-upload-btn {
            background: #8b8b8b;
            color: #222;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid #666;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.2s;
            display: inline-block;
            box-shadow: 0 4px 0 #555;
        }
        .file-upload-btn:hover {
            background: #999;
            transform: translateY(1px);
            box-shadow: 0 3px 0 #555;
        }
        .file-upload-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #555;
        }

        .controls {
            text-align: center;
            font-size: 12px;
            color: #333;
            margin-top: 10px;
        }
        
        /* Debug Panel Styles */
        .debug-panel {
            margin-top: 20px;
            background: #1a1a2e;
            border: 2px solid #4a4a6a;
            border-radius: 8px;
            padding: 15px;
            min-width: 350px;
        }
        .debug-title {
            color: #00ff00;
            font-size: 14px;
            margin-bottom: 10px;
            border-bottom: 1px solid #4a4a6a;
            padding-bottom: 5px;
        }
        .button-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        .btn-indicator {
            padding: 8px 4px;
            text-align: center;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            background: #333;
            color: #666;
            border: 1px solid #444;
            transition: all 0.1s;
        }
        .btn-indicator.active {
            background: #00ff00;
            color: #000;
            border-color: #00ff00;
            box-shadow: 0 0 10px #00ff00;
        }
        .debug-log {
            font-size: 11px;
            color: #aaa;
            max-height: 60px;
            overflow-y: auto;
            background: #0a0a15;
            padding: 8px;
            border-radius: 4px;
        }
        
        /* Audio Panel Styles */
        .audio-panel {
            margin-top: 15px;
            padding: 10px;
            background: #0a0a15;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }
        .audio-title {
            color: #00aaff;
            font-size: 12px;
        }
        .mute-btn {
            padding: 8px 20px;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid #00aaff;
            border-radius: 6px;
            background: transparent;
            color: #00aaff;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mute-btn:hover { background: #00aaff22; }
        .mute-btn.muted {
            background: #ff4444;
            border-color: #ff4444;
            color: white;
        }
        .audio-status {
            font-size: 11px;
            color: #666;
            display: block;
        }
    </style>
</head>
<body>

    <div class="gb-case">
        <div class="cartridge-slot">
            <label for="rom-upload" class="file-upload-btn">
                INSERT CARTRIDGE (.gb)
            </label>
            <input type="file" id="rom-upload" accept=".gb,.gbc" />
            <div id="rom-name" style="font-size: 10px; color: #555; margin-top: 5px;">No cartridge inserted</div>
        </div>

        <div class="screen-border">
            <canvas id="lcd" width="160" height="144"></canvas>
        </div>
        
        <div class="controls">
            <p>ARROWS | Z=A | X=B | ENTER=START | SHIFT=SEL</p>
        </div>
    </div>
    
    <div class="debug-panel">
        <div class="debug-title">üéÆ JOYPAD DEBUG - [UI Layer]</div>
        <div class="button-grid">
            <div class="btn-indicator" id="btn-up">‚Üë UP</div>
            <div class="btn-indicator" id="btn-down">‚Üì DOWN</div>
            <div class="btn-indicator" id="btn-left">‚Üê LEFT</div>
            <div class="btn-indicator" id="btn-right">‚Üí RIGHT</div>
            <div class="btn-indicator" id="btn-a">Z = A</div>
            <div class="btn-indicator" id="btn-b">X = B</div>
            <div class="btn-indicator" id="btn-select">SPC = SEL</div>
            <div class="btn-indicator" id="btn-start">‚èé START</div>
        </div>
        <div class="debug-log" id="debug-log">Waiting for input...</div>
        
        <div class="audio-panel">
            <div>
                <span class="audio-title">üîä AUDIO</span>
                <span class="audio-status" id="audio-status">Click to start</span>
            </div>
            <button class="mute-btn" id="mute-btn" onclick="toggleMute()">üîä ON</button>
        </div>
    </div>

    <script>
    // ============================================================
    // 1. GESTI√ìN DE CARGA DE ROM (NUEVO)
    // ============================================================
    const romInput = document.getElementById('rom-upload');
    const romNameDisplay = document.getElementById('rom-name');

    romInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        romNameDisplay.innerText = "Loading: " + file.name;

        const reader = new FileReader();
        reader.onload = function(event) {
            const data = new Uint8Array(event.target.result);
            
            // 1. Escribir el archivo en el sistema de archivos virtual de Emscripten
            // IMPORTANTE: 'FS' debe estar exportado en CMake
            try {
                Module.FS.writeFile('/game.gb', data);
                console.log("[JS] Archivo escrito en FS virtual: /game.gb (" + data.length + " bytes)");
                
                // 2. Llamar a la funci√≥n C++ para cargar la ROM
                // ccall(nombre_funcion, tipo_retorno, [tipos_args], [args])
                const success = Module.ccall(
                    'load_rom_from_js', // Nombre en C++ (exportado)
                    'number',           // Retorna int
                    ['string'],         // Recibe string (char*)
                    ['/game.gb']        // Argumento
                );

                if (success) {
                    console.log("[JS] C++ reporta √©xito cargando la ROM.");
                    romNameDisplay.innerText = "Playing: " + file.name;
                    romNameDisplay.style.color = "#008800";
                    
                    // Inicializar audio si es la primera interacci√≥n
                    initAudioOnInteraction();
                } else {
                    console.error("[JS] C++ reporta fallo cargando la ROM.");
                    romNameDisplay.innerText = "Error loading ROM";
                    romNameDisplay.style.color = "#cc0000";
                }

            } catch (err) {
                console.error("[JS] Error interactuando con Module:", err);
                romNameDisplay.innerText = "WASM Error (See Console)";
            }
        };
        reader.readAsArrayBuffer(file);
    });

    // ============================================================
    // 2. AUDIO SYSTEM
    // ============================================================
    let audioContext = null;
    let scriptNode = null;
    let isMuted = false;
    let audioInitialized = false;
    const SAMPLE_RATE = 44100;
    const BUFFER_SIZE = 2048; // Aumentado ligeramente para evitar crujidos en JS
    
    function toggleMute() {
        isMuted = !isMuted;
        const btn = document.getElementById('mute-btn');
        const status = document.getElementById('audio-status');
        
        if (isMuted) {
            btn.textContent = 'üîá OFF';
            btn.classList.add('muted');
            status.textContent = 'Muted';
            if (Module._set_audio_muted) Module._set_audio_muted(1);
        } else {
            btn.textContent = 'üîä ON';
            btn.classList.remove('muted');
            status.textContent = 'Playing';
            if (Module._set_audio_muted) Module._set_audio_muted(0);
            if (audioContext && audioContext.state === 'suspended') audioContext.resume();
        }
    }
    
    async function initAudio() {
        if (audioInitialized) return;
        
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)({
                sampleRate: SAMPLE_RATE
            });
            
            // ScriptProcessor (Deprecated pero simple para emuladores)
            scriptNode = audioContext.createScriptProcessor(BUFFER_SIZE, 0, 1);
            
            scriptNode.onaudioprocess = function(e) {
                const outputBuffer = e.outputBuffer.getChannelData(0);
                
                // Si no hay m√≥dulo o est√° muteado, silencio
                if (isMuted || !Module._fill_audio_buffer) {
                    outputBuffer.fill(0);
                    return;
                }
                
                // Pedir a C++ que llene su buffer interno y lo prepare
                const samplesCopied = Module._fill_audio_buffer(outputBuffer.length);
                
                if (samplesCopied > 0) {
                    // Leer directamente de la memoria WASM
                    const ptr = Module._get_audio_buffer();
                    // HEAPF32 usa √≠ndices de floats (bytes / 4)
                    const wasmView = Module.HEAPF32.subarray(ptr >> 2, (ptr >> 2) + samplesCopied);
                    
                    // Copiar
                    outputBuffer.set(wasmView);
                    
                    // Si faltaron samples, rellenar con el √∫ltimo valor (o 0)
                    if (samplesCopied < outputBuffer.length) {
                        outputBuffer.fill(0, samplesCopied);
                    }
                } else {
                    outputBuffer.fill(0);
                }
            };
            
            scriptNode.connect(audioContext.destination);
            audioInitialized = true;
            document.getElementById('audio-status').textContent = 'Audio Ready';
            console.log('[AUDIO] Inicializado.');
            
        } catch (err) {
            console.error('[AUDIO] Error:', err);
        }
    }
    
    function initAudioOnInteraction() {
        if (!audioInitialized) initAudio();
        else if (audioContext && audioContext.state === 'suspended') audioContext.resume();
    }
    
    document.addEventListener('click', initAudioOnInteraction, { once: true });
    document.addEventListener('keydown', initAudioOnInteraction, { once: true });
    
    // ============================================================
    // 3. DEBUG UI & INPUT
    // ============================================================
    const buttonState = { 0: false, 1: false, 2: false, 3: false, 4: false, 5: false, 6: false, 7: false };
    const BUTTON_NAMES = ['RIGHT', 'LEFT', 'UP', 'DOWN', 'A', 'B', 'SELECT', 'START'];
    const BUTTON_ELEMENTS = { 0: 'btn-right', 1: 'btn-left', 2: 'btn-up', 3: 'btn-down', 4: 'btn-a', 5: 'btn-b', 6: 'btn-select', 7: 'btn-start' };
    
    function updateDebugUI() {
        for (let id = 0; id < 8; id++) {
            const el = document.getElementById(BUTTON_ELEMENTS[id]);
            if (el) el.classList.toggle('active', buttonState[id]);
        }
        
        const pressed = Object.keys(buttonState).filter(k => buttonState[k]).map(k => BUTTON_NAMES[k]);
        document.getElementById('debug-log').textContent = pressed.length > 0 ? `Pressed: ${pressed.join('|')}` : 'Idle';
    }
    
    // ============================================================
    // 4. WASM MODULE & MAIN LOOP
    // ============================================================
    var Module = {
        canvas: document.getElementById('lcd'),
        onRuntimeInitialized: function() {
            console.log("[WASM] Inicializado. Esperando ROM...");
            setupKeyboard();
        }
    };

    function drawCanvas() {
        // Esta funci√≥n es llamada desde C++ (emc_main.cpp) cada frame
        if (!Module._get_video_buffer) return;

        const bufferPointer = Module._get_video_buffer();
        
        // Si C++ devuelve 0 (nullptr), significa que no hay juego o PPU listo
        if (bufferPointer === 0) return; 

        // Copiar p√≠xeles de la memoria WASM al Canvas
        // HEAPU8 es la vista de bytes de toda la memoria
        const data = new Uint8ClampedArray(Module.HEAPU8.buffer, bufferPointer, 160 * 144 * 4);
        const imgData = new ImageData(data, 160, 144);
        
        const ctx = document.getElementById('lcd').getContext('2d');
        ctx.putImageData(imgData, 0, 0);
    }
    
    const KEY_MAP = {
        'ArrowRight': 0, 'ArrowLeft': 1, 'ArrowUp': 2, 'ArrowDown': 3,
        'KeyZ': 4, 'KeyX': 5, 'ShiftLeft': 6, 'Enter': 7
    };
    
    function setupKeyboard() {
        const handler = (e, isDown) => {
            const btn = KEY_MAP[e.code];
            if (btn !== undefined) {
                e.preventDefault();
                if (buttonState[btn] !== isDown) {
                    buttonState[btn] = isDown;
                    updateDebugUI();
                    if (Module._set_button) Module._set_button(btn, isDown);
                    
                    // Iniciar audio en primera tecla si no se hizo click
                    if (isDown) initAudioOnInteraction();
                }
            }
        };
        document.addEventListener('keydown', e => handler(e, true));
        document.addEventListener('keyup', e => handler(e, false));
    }
    </script>

    <script async type="text/javascript" src="gb-emu.js"></script>

</body>
</html>
